<div class="container" *ngIf="tab">
  <mat-paginator [pageSize]="tab.pageSize"
                 [pageIndex]="tab.pageIndex"
                 [length]="tab.totalCount"
                 [hidePageSize]="true"
                 (page)="onPageChange($event)">
  </mat-paginator>
  <mat-divider></mat-divider>

  <div class="table-container">
    <mat-table #table
               [dataSource]="rows$"
               [trackBy]="trackByRowId"
               matSort
               multiTemplateDataRows
               (matSortChange)="onSortClick($event)">

      <ng-container *ngFor="let col of getVisibleColumns()"
                    [ngSwitch]="col.name">

        <!-- First column with checkboxes -->
        <ng-container *ngSwitchCase="'_checked'" matColumnDef="{{col.name}}">
          <!-- Header -->
          <mat-header-cell class="column_small" *matHeaderCellDef>
            <mat-icon class="icon material-icons"
                      color="primary"
                      (click)="onHeaderCheckClick($event);">
              {{getCheckIcon()}}
            </mat-icon>
          </mat-header-cell>
          <!-- Cell -->
          <mat-cell class="column_small" *matCellDef="let currRow;">
            <mat-icon class="icon material-icons"
                      color="primary"
                      (click)="onRowCheckClick($event, currRow);">
              {{currRow._checked ? 'check_box' : 'check_box_outline_blank'}}
            </mat-icon>
          </mat-cell>
          <!-- Footer -->
          <mat-footer-cell  class="column_small" *matFooterCellDef>
              <mat-icon (click)="onStatisticsHelp()">
                functions
              </mat-icon>
            </mat-footer-cell>
          </ng-container>

        <!-- Column with + for expanding details -->
        <ng-container *ngSwitchCase="'_details'" matColumnDef="{{col.name}}">
          <mat-header-cell class="column_small" *matHeaderCellDef></mat-header-cell>
          <mat-cell class="column_small"
                    *matCellDef="let currRow;">
            <span *ngIf="currRow.related_featuretypes.length === 0" class="iconCharNo">+</span>
            <span *ngIf="currRow.related_featuretypes.length > 0"
                  class="iconChar"
                  (click)="onRowExpandClick($event, currRow);">{{ currRow._expanded ? '-': '+'}}</span>
          </mat-cell>
          <mat-footer-cell  class="column_small" *matFooterCellDef></mat-footer-cell>
        </ng-container>

        <!-- Columns with data -->
        <ng-container *ngSwitchDefault matColumnDef="{{col.name}}">
          <!-- Header -->
          <mat-header-cell *matHeaderCellDef mat-sort-header >
            {{col.alias || col.name}}
            <mat-icon [ngClass]="(getIsFilterActive(col.name))? 'material-icons-set': 'material-icons-unset' " (click) = "$event.stopPropagation();onFilterClick(col.name)">
              filter_list
            </mat-icon>
          </mat-header-cell>
          <!-- Cell -->
          <mat-cell *matCellDef="let currRow" >{{currRow[col.name]}}</mat-cell>
          <!-- Footer -->
          <mat-footer-cell *matFooterCellDef (contextmenu)="onStatisticsMenu($event, col.name)">
            <div *ngIf="isStatisticsProcessing(col.name)">
              <mat-spinner diameter="20"></mat-spinner>
            </div>
            {{getStatisticResult(col.name)}}
          </mat-footer-cell>
        </ng-container>
      </ng-container>

      <ng-container matColumnDef="expandedDetail">
        <mat-cell *matCellDef="let currRow" [attr.colspan]="getColumnNames().length">
          <div class="details-container" *ngIf="currRow._expanded">
            <tailormap-attributelist-details
              *ngFor="let featureType of currRow.related_featuretypes"
              [parentLayerId]="tab.layerId"
              [parentLayerName]="tab.layerName"
              [featureType]="featureType">
            </tailormap-attributelist-details>
          </div>
        </mat-cell>
      </ng-container>

      <!-- Columns with related details data -->
      <mat-header-row *matHeaderRowDef="getColumnNames(); sticky: true;"></mat-header-row>

      <mat-row *matRowDef="let row; columns: getColumnNames();"
               (click)="onRowClick($event, row);"></mat-row>

      <mat-row *matRowDef="let row; columns: ['expandedDetail']" class="details-row" [@detailExpand]="row._expanded ? 'expanded' : 'collapsed'"></mat-row>

      <mat-footer-row *matFooterRowDef="getColumnNames(); sticky: true;"></mat-footer-row>

    </mat-table>
  </div>

  <div style="visibility: hidden; position: fixed;"
       [style.left]="contextMenuPosition.x"
       [style.top]="contextMenuPosition.y"
       [matMenuTriggerFor]="statisticsMenu">
  </div>

  <mat-menu #statisticsMenu="matMenu">
    <ng-template matMenuContent let-colName="col.name">
      <ng-container *ngFor="let statType of keys(eStatisticType) ">
        <div *ngIf="getStatisticFunctionColumnType(colName) === 'numeric' && eStatisticType[statType] !== 'COUNT' && eStatisticType[statType] !== 'NONE'">
           <button mat-menu-item (click)="onStatisticsMenuClick(colName, eStatisticType[statType])">
             <mat-icon [ngClass]="(getStatisticTypeInMenu(colName) === eStatisticTypeInMenu[statType])? 'menu-icon material-icons-set': 'menu-icon material-icons-off'">
               check
             </mat-icon>
             {{eStatisticTypeInMenu[statType]}}
           </button>
        </div>
      </ng-container>
      <ng-container *ngFor="let statType of keys(eStatisticType) ">
        <div *ngIf="eStatisticType[statType] === ('COUNT')">
          <button mat-menu-item (click)="onStatisticsMenuClick(colName, eStatisticType[statType])">
            <mat-icon [ngClass]="(getStatisticTypeInMenu(colName) === eStatisticTypeInMenu[statType])? 'menu-icon material-icons-set': 'menu-icon material-icons-off'">
              check
            </mat-icon>
            {{eStatisticTypeInMenu[statType]}}
          </button>
        </div>
      </ng-container>
      <mat-divider></mat-divider>
      <ng-container *ngFor="let statType of keys(eStatisticType) ">
        <div *ngIf="eStatisticType[statType] === ('NONE')">
          <button mat-menu-item (click)="onStatisticsMenuClick(colName, eStatisticType[statType])">
            <mat-icon [ngClass]="(getStatisticTypeInMenu(colName) === eStatisticTypeInMenu[statType])? 'menu-icon material-icons-set': 'menu-icon material-icons-off'">
              check
            </mat-icon>
            {{eStatisticTypeInMenu[statType]}}</button>
        </div>
      </ng-container>
    </ng-template>
  </mat-menu>
</div>
